<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mappers.RsvMapper">

	<!-- RSV PART -->
	<resultMap type="RsvVO" id="rsvResult">
		<id property="rsvNo" column="i_rsv" />
		<result property="rsvDate" column="rsv_date" />
		<result property="rsvCdate" column="rsv_cDate" />
		<result property="rsvMemNo" column="i_member" />
		<association property="rsvPay" resultMap="payResult"/>
		<collection property="rsvInfoMap" javaType="map" ofType="OrgStInfoVO">
			<association property="osOres" resultMap="mappers.OrgMapper.oresResult"/>
			<association property="osSt" resultMap="mappers.SeatMapper.seatResult"/>
		</collection>
	</resultMap>

	<insert id="insertRsv" useGeneratedKeys="true" keyColumn="i_rsv" keyProperty="rsvNo">
		insert into t_rsv values(0, now(), null, #{rsvMemNo});
	</insert>
	
	<update id="cancelRsv">
		update t_rsv set rsv_cDate = now() where i_rsv = #{rsvNo};
	</update>
	
	<!-- RSVINFO PART -->
	<resultMap type="RsvResultVO" id="rResResult">
		<id property="rrRsvNo" column="i_rsv" />
		<result property="rrRsvDate" column="rsv_date" />
		<result property="rrRsvCdate" column="rsv_cDate" />
		<association property="rrMem" resultMap="mappers.MemberMapper.memberResult"/>
		<association property="rrPay" resultMap="payResult"/>
		<association property="org" resultMap="mappers.OrgMapper.orgResult"/>
		<association property="th" resultMap="mappers.TheaterMapper.thResult"/>
		<association property="pg" resultMap="mappers.ProgramMapper.programResult"/>
		<collection property="rrSeatList" ofType="SeatVO" javaType="list" resultMap="mappers.SeatMapper.seatResult"/>
	</resultMap>
	
	<insert id="insertRsvInfo">
		insert into t_rsv_info values(0, #{rsvNo}, #{orgNo}, #{stNo});
	</insert>
	
	<select id="selectRsv" resultMap="rResResult">
		select * from t_rsv_info ri 
				join t_rsv rsv using(i_rsv)
				join t_org org using(i_org) 
				join t_theater th using(i_theater) 
				join t_program pg using(i_program)
				join t_seat st using(i_seat)
				join t_pay pay using(i_rsv)
				join t_member mem on rsv.i_member = mem.i_member
			where i_rsv = #{rsvNo};
	</select>
	
	<select id="selectRsvList" resultMap="rResResult">
		select * from t_rsv_info ri 
				join t_rsv rsv using(i_rsv)
				join t_org org using(i_org) 
				join t_theater th using(i_theater) 
				join t_program pg using(i_program)
				join t_seat st using(i_seat)
				join t_pay pay using(i_rsv)
				join t_member mem on rsv.i_member = mem.i_member
			order by i_rsv desc;
	</select>
	

	<!-- PAY PART -->
	<resultMap type="PayVO" id="payResult">
		<id property="pyNo" column="i_pay" />
		<result property="pyPrice" column="py_price" />
		<result property="pyType" column="py_type" />
		<result property="pyNum" column="py_num" />
		<result property="pyValidMonth" column="py_validMonth" />
		<result property="pyValidYear" column="py_validYear" />
		<result property="pyDate" column="py_date" />
		<result property="pycDate" column="py_cDate" />
		<result property="pyState" column="py_state" />
		<result property="pyRsvNo" column="i_rsv" />
		<result property="pyMemNo" column="i_member" />
	</resultMap>
	
	<insert id="insertPay">
		insert into t_pay values(0, #{pyPrice}, #{pyType}, #{pyNum}, #{pyValidMonth}, #{pyValidYear}, now(), null, 0, #{pyRsvNo}, #{pyMemNo});
	</insert>
	
	<update id="cancelPay">
		update t_pay set py_cDate = now() where i_rsv = #{rsvNo};
	</update>
	
	<select id="selectPayList">
		select * from t_pay order by i_pay desc;
	</select>
	
	<select id="selectPay">
		select * from t_pay where i_pay = #{pyNo};
	</select>
	
	
</mapper>